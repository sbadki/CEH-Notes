## Lab Tasks

> Note: Ensure that the **Windows Defender Firewall is Turn off** on the machines you are using for the lab tasks in this module, as it blocks and deletes malware as soon as it is executed.

Attackers, as well as ethical hackers or pen testers, use numerous tools and techniques to gain access to the target network or machine. Recommended labs that will assist you in learning various malware attack techniques include:
Thus, taking its cue from this myth, a computer Trojan is a program in which malicious or harmful code is contained inside apparently harmless programming or data in such a way that it can gain control and cause damage such as ruining the file allocation table on your hard disk.

**Lab 1. Gain access to the target system using Trojans

Attackers use Remote Access Trojans (RATs) to infect the target machine to gain administrative access. RATs help an attacker to remotely access the complete GUI and control the victim’s computer without his/her awareness. They can perform screening and camera capture, code execution, keylogging, file access, password sniffing, registry management, and other tasks. The virus infects victims via phishing attacks and drive-by downloads and propagates through infected USB keys or networked drives. It can download and execute additional malware, execute shell commands, read and write registry keys, capture screenshots, log keystrokes, and spy on webcams.

**Task 1: Gain control over a victim machine using the njRAT RAT Trojan**

njRAT is a RAT with powerful data-stealing capabilities. In addition to logging keystrokes, it is capable of accessing a victim’s camera, stealing credentials stored in browsers, uploading and downloading files, performing process and file manipulations, and viewing the victim’s desktop.

	[Windows 11] - attacker
	Navigate to njRAT and double-click njRAT v0.7d.exe
	njRat GUI open, if asks for port,enter port (default port 5552)
	Click Builder (lower left -corner)
	Enter Ip of attacker,check the option Registy StarUp, leave the other settings to default, and click Build.
	Save As Test.exe on Desktop

Now, use any technique to send this server to the intended target through email or any other source (in real-time, attackers send this server to the victim).
Note: In this task, we copied the **Test.exe** file to the shared network location (**CEH-Tools**) to share the file.

	[Windows Server 22] - Victim
	Copy Test.ext to Desktop and Run
	
	[Windows 11]
	Windows 11 establishes a persistent connection with the victim machine
	Right click on detected victim and click Manager
	"Process Manager" -> Right click -> Kill/Delete/Restart
	Connectoin -> Right click -> Kill Connection
	Registry -> Right click -> associated registry files
	Remote Shell -> launch remote conn on Win 22
	
	cmd>ipconfig/all -> lower left conrner
	Services -> start/pause/stop service
	Close Manager window
	
	Right click on victim name -> Remote Desktop (Launches remote connection)
	select Mouse Checkbox
	Now, you will be able to remotely interact with the victim machine using the mouse.
Note: If you want to create any files or write any scripts on the victim machine, you need to check the **Keyboard** option.

	Right click on victim name ->Remote Cam -> Microphone

	[Windows 2022]
	As a victim perform some activity on machine, create a secret file and save.

	[Windows 11]
	Right click on victim name -> Keylogger -> Able to view all keystrokes performed by victim
	Right click on victim name -> open chat -> send msg to victim

	[Windows 22]
	if victim sees message, might try to restart the machine, njRat will loose teh connection but when victim logs back in connection establishes.
	After task completion
	Launch Task manager -> More details -> server.exe -> End task

-------
**Task 2 : Hide a Trojan using SwayzCryptor and make it undetectable to various anti-virus programs**
At present, numerous anti-virus software programs have been configured to detect malware such as Trojans, viruses, and worms. Although security specialists keep updating the virus definitions, hackers continually try to evade or bypass them. One method that attackers use to bypass AVs is to “crypt” (an abbreviation of “encrypt”) the malicious files using fully undetectable crypters (FUDs). Crypting these files allows them to achieve their objectives, and thereby take complete control over the victim’s machine.

Crypter is a software that encrypts the original binary code of the .exe file to hide viruses, spyware, keyloggers, and RATs, among others, in any kind of file to make them undetectable by anti-viruses. SwayzCryptor is an encrypter (or “crypter”) that allows users to encrypt their program’s source code.

	[windows 11]
	https://www.virustotal.com -> upload & see no of vul identified -> 59/69 vul shows
	Run SwayzCryptor.exe ->Select file -> Desktop/Test.exe ->check the options Start up, Mutex, and Disable UAC, and then click Encrypt.
	Save file dialog -> cryptedfile.exe 
	https://www.virustotal.com -> upload crypted.exe -> confirm upload -> only few anivirus will detect its malacious file
	
	Start njRAT v0.7d.exe
	Share CryptedFile.exe via shared folder

	[windows 22]
	copy crypted.exe from shared to desktop -> run -> Attacker machine establishes a persistent connection with the victim machine.

	[windows 11]
	can observe that the connection has been established with the victim machine.
Unless the attacker working on the **Windows 11** machine disconnects the server on their own, the victim machine remains under their control.
Thus, you have created an undetectable Trojan that can bypass the anti-virus and firewall programs, as well as be used to maintain a persistent connection with the victim.

On completion of this lab, click Windows Server 2022, launch **Task Manager**, click on **More details** and look for the **server.exe (32 bit)** process, and click **End task** on the **Windows Server 2022** machine.

------
**Task 3: Create a Trojan Server using Theef RAT Trojan**

Theef is a Remote Access Trojan written in Delphi. It allows remote attackers access to the system via port 9871. Theef is a Windows-based application for both client and server. The Theef server is a virus that you install on a target computer, and the Theef client is what you then use to control the virus.

	Generally, an attacker might send a server executable to the victim machine and entice the victim into running it. In this lab, for demonstration purposes, we are 
	directly executing the file on the victim machine, Windows Server 2022.

	[Windows 22] - victim
	Z:\..\Theef\Server210.exe -> Run

	[windows 11] - attacker
	E:..\Theef\Client210.exe  -> Run ->	Ip address: 10.10.1.22,	port & ftd - default -> connect
	Etablished remote connection with victim
	
	Computer Information, you can view PC Details, OS Info, Home, and Network by clicking their respective buttons.
	Can perform various operations such as capture screens, log keys, view processes, view the task manager, use the webcam, and use the microphone on the victim 
	machine by selecting their respective options.
	selecting Task Manager views the tasks running on the target machine.
	select a proecess; click close windows (X)

	Spy menu -> keylogger -> start
	
	[windows 2022]
	browse website or create secrete file
	
	[windpws 11]
	To view the recorded keystrokes of the victim machine in the **Theef** Keylogger window.
---
**Lab 2: Infect the Target System using a Virus**
- Create a virus using the JPS Virus Maker Tool and infect the target system**

  	[Windows 2019]
  	Z:\..Virus Maker\JPS Virus maker -> run jps.exe [sec warn run]
  	Check Autostartup checkbox
  	 Virus Options, check following options -> 
  	 Disable TaskManager,Disable Windows Update,Disable Control Panel,Disable Drives,Hide Windows Clock,Hide Desktop Icons,Enable Remote Desktop,Remove Bluetooth,Turn 
  	 Off Windows Firewall,Turn Off Windows Defender, andAuto Startup.

  	Ensure that the None radio button is selected to specify the trigger event when the virus should start attacking the system after its creation.
  	 before clicking on Create Virus!, click the right arrow icon from the right-hand pane of the window to configure the virus options.
  	Change Windows Password, Change Computer Name
  	JPG Icon radio button is selected - Change Icon - None radio button
  	Create Virus! button and select x86(64Bit); click Create Virus!

![[Pasted image 20231128122451.png]]

	Server.exe is created.
	pack this virus with a binder or virus packager and send it to the victim machine through email, chat, a mapped network drive, or other method.
	Server.exe copy in shared folder.

	[windows server]
	Wont be able to login with password, try with changed pwd
	Run server.exe and open task manager -> wont be able to perform restriced actions.
	
------
**Lab 3:Perform static malware analysis**
- Task 1: Perform malware scanning using Hybrid Analysis

	[Windows 11]
	https://www.hybrid-analysis.com -> drag and drop Viruses\tini.exe and observe
	provide email, consent, continue. -> GO

------
- Task 2 :Perform a strings search using BinText

	[Windwos 11]
	 Run bintext.exe ->String searching tool
	 select Advance view
	 select "face.exe" from shared - Viruses\Klez Virus Live! 
   ------
- Task 3: Identify packaging and obfuscation methods using PEid

	[Windows 11]
	Packaging and Obfuscation Tools\PEid - PEiD.exe
	Open file Z:\Viruses\Klez Virus Live!, select the face.exe
As soon as you click **Open**, PEiD analyzes the file and provides information, as shown in the screenshot.

------
- Task 4: Analyze ELF executable file using Detect It Easy (DIE)

	[Windwos 11]
	Z:\..\Packaging and Obfuscation Tools\DIE and double-click die.exe.
	Open Z:\..\Viruses\ELF Test File
	Detect It Easy automatically scans the file and result appears showing the Operating system, compiler and language details in the middle pane
	File info/Hash/Entropy and other details -> click and see details -> close
	
------
- Task 5: Find the portable executable (PE) information of a malware executable file using PE Explorer
  open, view, and edit a variety of different 32-bit Windows executable file types (also called PE files) ranging from common such as EXE, DLL, and ActiveX Controls to less familiar types such as SCR (Screensavers), CPL (Control Panel Applets), SYS, MSSTYLES, BPL, DPL, and more (including executable files that run on MS Windows Mobile platform).

	 Install PE.Explorer_setup.exe
	 Open file Z:\..\Viruses\Klez Virus Live!\face.exe
	 Data Directories ->to view and edit the virtual address and size of the chosen directory describing provisions of parts of the code.
	Section Headers->

The **HEADERS INFO** section provides you with the ability to:

- View and save a text report on the file headers information
- Modify the entry point value
- Updates the value of the checksum in the header
- Set flag bits in the file header characteristics field

------
- Task 6: Identify file dependencies using Dependency Walker
  File dependencies contain information about the internal system files that the program needs to function properly; this includes the process of registration and location on the machine.
  DLLs used to load and run a program:
  ![[Pasted image 20231128152057.png]]

  Z:\..\Dependency Walker\depends.exe
  open Z:\..\Klez Virus Live!\snoopy.exe
  Observer Import and Export section.
-------
- Task 7: Perform malware disassembly using IDA and OllyDbg

**IDA** As a disassembler, IDA explores binary programs,to display the instructions actually executed by the processor in a symbolic representation called “assembly language.”
**OllyDbg** OllyDbg is a debugger that emphasizes binary code analysis, which is useful when source code is unavailable. It traces registers, recognizes procedures, API calls switches, tables, constants, and strings, and locates routines from object files and libraries.

	[Windows 11]
	IDA Freeware
	IDA: Quick start -> New -> select malicious file face.exe
	Portable executable for 80386 (PE) [pe64.dll] option selected -> OK
	IDA View-A tab -> Right click -> Text view


	Disassembling and Debugging Tools\IDA, Copy the qwingraph.exe file and paste it in IDA’s installation location. C:\Program Files\IDA Freeware 7.7
	IDA-> View-> Graphs-> Flow Chart
	View -> Graphs -> Function calls
	HexView-1 tab -> view hex value of the malicious file
	Structure
	Enums

	OllyDbg\OLLYDBG.EXE
	Note: When you launch OllyDbg for the first time, several sub-windows might appear in the main window of OllyDbg; close all of them.
	File -> Open ->Z:\..\Viruses\tini.exe
	Output appears in -> CPU - main thread, module tini
	View-> Log
	Log data appears ->displays the program entry point and its calls to known functions
	View->Executable modules
	View->Memory
	View->Thread
-------
- Task 8: Perform malware disassembly using Ghidra
  -reverse engineering (SRE) framework
  -analyze compiled code on a variety of platforms including Windows, MacOS, and Linux. It's capabilities include disassembly, assembly, decompilation, debugging, emulation, graphing, and scripting.

	\Ghidra\ghidraRun.bat
	If a Command Prompt window appears, then type C:\Program Files\jdk-17.0.2+8 and press Enter
	Ghidra: NO ACTIVE PROJECT -> File -> New Project
	Non-Shared Project -> Proj Name: Malware Analysis -> Finish
	File->Import file -> Klez Virus Live!\face.exe -> Import Result Summary -> OK
	
	Face.exe is added as a children node under the Malware Analysis project
	Double click Face.exe -> Analyse -> Yes
	under Symbol Tree, you can observe various components of face.exe file such as Imports, Exports, Functions and Labels
	Expand Imports -> view DLL files
	
	Program Tree->Headers double click
						-> Double click .rdata
------
**Lab4. Perform dynamic malware analysis**
involves executing malware code to learn how it interacts with the host system and its impact after infecting the system.
It reveals information such as domain names, file path locations, created registry keys, IP addresses, additional files, installation files, and DLL and linked files located on the system or network.

- Task1: Perform port monitoring using TCPView and CurrPorts

  	[Windows 11] - ATTACKER
  	njRAT v0.7d.exe  -> Start
  	Builder -> 10.10.1.11 -> Check "Registry StarUp" -> rename ExeName as Trojan.exe -> Build -> Save as Trojan.exe on shared drive
  	
  	[Windows 22] -VICTIM
  	Run Trojan.exe from shared drive
  	
  	[Windows 11]
  	established connection
  	
  	[Windows 22]
  	\TCPView\Tcpview.exe
  	displaying the details such as Process, ProcessId, Protocol, Local Address, Local Port, Remote Address, Remote Port, and State
  	Port monitoring -> Click the Local Port tab to view the ports in serial order, Observer Protocol
  	TCTP view -> Search Trojan.exe -> look for Remtoe address and remote port -> Right click and Kill

  	This way, you can view all processes running on the machine and stop unwanted or malicious processes that may affect your system. If you are unable to stop a 
  	process, you can view the port on which it is running and add a firewall rule to block the port		

  	[Windows 22]
  	CurrPorts -> Run cports.exe -> display list of currently open TCP/IP and UDP ports on the machine.
  	Look for Trojan.exe - port 5552
  	Right click -> properties (name of the process, its process ID, Remote Address, Process Path, Remote Host Name, and other details)
  	Right click -> Kill Processes Of Selected Ports
  	Alternatively, select Close Selected TCP Connections, so that the port closes, and the attacker can never regain connection through the port unless you open it.
  	No -> use it for next step
------
- Task 2: Perform process monitoring using Process Monitor
  -use the Process Monitor tool to detect suspicious processes.

  [Windows 22]
  launch ProcessMonitor\Procmon.exe
	 Look for Trojan.exe -its running ->Right click Properties -> Event properties
------
- Task 3: Perform registry monitoring using Reg Organizer
  Windows Registry stores OS and program configuration details such as settings and options. If the malware is a program, the registry stores its functionality. When an attacker installs a type of malware on the victim’s machine, it generates a registry entry.

Reg Organizer to scan the registry values for any changes.

	[Windows 11]
	Launch \Reg Organizer\reg-organizer-setup.exe - installation
	Reg Organization main window appears, displaying System Cleanup, Startup Applications and Private Data Cleanup
	Tools -> Registry Snapshots -> create snapshot
	Snapshot initializes and after it finishes, the Snapshot Created window appears; change the snapshot name to Shot 1 in the Enter the snapshot name field and 
	click OK

	For demonstration install SoftPerfect Network Scanner & see Registry changes
	Luanch \Module 04 Enumeration\SNMP Enumeration Tools\SoftPerfect Network Scanner\netscan_setup.exe
	Do not launch & finish
	
	Click Compare with Current Registry option ->Revealed Differences window appears
	
	![[Pasted image 20231128171923.png]]

-------
- Task4: Perform Windows services monitoring using Windows Service Manager (SrvMan)

SrvMan tool to check for suspicious windows services

	[WIndows 11]
	Launch \Windows Service Manager (SrvMan)\x64\srvman.exe
	Choose any unwanted service that is running on your computer, and Stop or Delete that service by choosing the appropriate action.

------
- Task 5: Perform startup program monitoring using Autoruns for Windows and WinPatrol

  	[Windows 11]
  	launch -> Dynamic Analysis\Windows statup..\Windows Startup Programs Monitoring Tools\Autoruns for Windows\Autoruns.exe
  	Click Logon tab  -> to view the applications that run automatically during login.
  	Explorer -> explorer applications that run automatically at system startup.
  	Services ->  displays all services that run automatically at system startup.
  	Drivers/Known DLLs  -> view all application drivers/known dlls that run automatically at system startup
  	CLOSE

  	Which applications or processes start when the system boots up using the WinPatrol tool.
  	launch \WinPatrol\wpsetup.exe -> Start the appln -> finish
  	WinPartol application window appears with the PLUS tab -> Explore other tabs
------
- Task 6: Perform installation monitoring using Mirekusoft Install Monitor

Installation monitoring help to detect hidden and background installations that malware performs.

	[WIndows 11]
	launch \Installation Monitoring Tools\Mirekusoft Install Monitor\SetupInstallMonitor.exe
	
	Click Skip scan in the Home tab.
	Programs tab -> Uninstall any program to remove it from your machine.
	Startup tab -> view the programs that run automatically on Windows Startup.
	Disable task which u wish to.

- Task 7: Perform files and folder monitoring using PA File Sight

  	[Windows 11]
  	Launch \Files and Folder Monitoring Tools\PA File Sight\FileSight_Trial_Key_E71BE154-2386-4CF3-BEA3-75830C985736.exe
  	Select preferred language, and then click OK
  	select the File Sight Monitor icon, and then click OK

  	Start Your Trial! window appears, ensure that Ultra radio button is selected and click Install Trial License
  	Completing the PA File Sight Setup Wizard appears; make sure that both the 
  	- Start the PA File Sight monitoring service
  	- Launch the PA File Sight Console options are checked -> Finish
  	Note: If a Start Wizard window appears, close it.

  	[Windows 22]
  	Launch \Files and Folder Monitoring Tools\PA File Sight\FileSight_Trial_Key_E71BE154-2386-4CF3-BEA3-75830C985736.exe
  	Click Next button until you see the Select Components wizard.
  	Only check Satellite Monitoring Service -> Next
  	Checkbox - Start the PA File Sight Satellite Monitoring Service and - Configure the PA File Sight Satellite service options ->Finish

  	Configure Satellite Monitoring Service Window
  	Central monitoring service address -> 10.10.1.11:8000 -> Apply settings
  	Stop satellite service to stop
  	Start satellite service -> Exit

  	Desktop\secret.txt -> content "This is my password"

  	[Windows 11]
  	PA File Sight starts monitoring - Windows 22
  	Expand the Server2022 node, select Inventory Collector in the left-hand pane, and click the Apply button from the right-hand pane.
  	Right-click on Inventory Collector and click Run Now! ->see the complete system information scroll down in right pain
  	Right-click on Server2022 and click the Add New Monitor ->select the File Sight Monitor icon, and then click OK

![[Pasted image 20231128175049.png]]

	Click Actions -> click New under Global Action List
	The Add New Action window appears. Select the Action List icon and click OK
	Type a description in the Description field and click Add to choose actions.
	 Choose Action to Add window appears; choose any action from the list and click OK
	The Monitor Actions window appears; choose the newly created action (here, Monitoring File); and then click the << icon to add the action -> OK	

![[Pasted image 20231128175538.png]]

	Under the Server2022 node, Watch node will be added, select it and click Apply from the right-pane. Then right-click on the File Monitoring / Watch node and 
	click Run Now! from the context menu.

![[Pasted image 20231128175725.png]]

	Click the Server2022 node to view the dashboard. Scroll down in the dashboard; observe that the File Monitoring directory is being monitored.

	[win22]
	modify Desktop/secrete.txt
	
	[win11]
	observe that PA File Sight has recorded some activity in the notepad file

	[win22]
	delete Desktop/secrete.txt

	[win11]
	alert shows
------
- Task 8: Perform device driver monitoring using DriverView and Driver Reviver

  	[Windows 11]
  	Launch \Device Drivers Monitoring Tools\DriverView\DriverView.exe
  	Right click on any driver -> properties

  	launch \Driver Reviver -> after installation see Status as OUTDATED or UP TO DATE. Explore other tabs.
  	Update All button to update all the drivers.
  	Uninstall the Driver Reviver software by navigating to Control Panel --> Programs --> Uninstall a program

------
- Task 9: Perform DNS monitoring using DNSQuerySniffer

  	[Windows 22]
  	launch DNSQuerySniffer.exe
  	the Capture Options window, -> WinPcap Packet Capture Driver option is selected under the Capture Method field.
  	 select the Windows Server 2022 network adapter (Ethernet) -> OK -> 5 mints to capture traffic
  	 
  	 Note: To view the Source Address and Destination Address columns, scroll to the right side of the window.
  	 
  	 In real-time, attackers will use malicious applications like DNSChanger to change the DNS of the target machine. For demonstration purposes, we are changing the 
  	 DNS of the Windows Server 2022 machine in the Network & Internet settings.

  	Open Network & Internet settings -> Change adapter options -> Right click -> Properties ->Select Internet Protocol Version 4 (TCP/IPv4) and 
  	click Properties.
  	Change the Preferred DNS server IP address to 10.10.1.11 and click OK

  	 Swith to DNSQuerySniffer
  	 Observer logs, 10 minutes to capture the logs.
  	 After completion of the task, go to the network settings, change DNS **8.8.8.8** in the **Windows Server 2022** machine, and close all applications.